{% extends "base.html" %}

{% block title %}Report Card - {{ student.username }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0">Report Card</h2>
    <small class="text-muted">Class: {{ classroom.name }} • Student: {{ student.username }}</small>
  </div>
  <div class="btn-group">
    <button class="btn btn-outline-secondary" onclick="window.print()">Print/Save PDF</button>
    <a class="btn btn-secondary" href="{{ url_for('classroom_students', class_id=classroom.id) }}">Back to Students</a>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="text-muted">Average</div>
        <div class="display-6">{% if avg is not none %}{{ '%.1f'|format(avg) }}%{% else %}<span
            class="text-muted">—</span>{% endif %}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="text-muted">Best</div>
        <div class="display-6">{% if best is not none %}{{ '%.1f'|format(best) }}%{% else %}<span
            class="text-muted">—</span>{% endif %}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="text-muted">Worst</div>
        <div class="display-6">{% if worst is not none %}{{ '%.1f'|format(worst) }}%{% else %}<span
            class="text-muted">—</span>{% endif %}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <div class="text-muted">Completed</div>
        <div class="display-6">{{ rows|selectattr('submission')|select|list|length }}/{{ rows|length }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Performance Over Assignments</h5>
    <canvas id="perfChart" height="120"></canvas>
    <p class="mt-3 mb-0"><strong>Analysis:</strong> {{ analysis_text }}</p>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h5 class="card-title">Grades by Assignment</h5>
    {% if rows %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Assignment</th>
            <th>Created</th>
            <th>Status</th>
            <th>Score</th>
            <th>Percentage</th>
            <th class="text-end">Manage</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          {% set a = r.assignment %}
          {% set s = r.submission %}
          <tr>
            <td>{{ a.title }}</td>
            <td>{{ a.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>
              {% if s %}
              <span class="badge bg-success">Submitted</span>
              <div><small class="text-muted">{{ s.submitted_at.strftime('%Y-%m-%d %H:%M') }}</small></div>
              {% else %}
              <span class="badge bg-secondary">Not Submitted</span>
              {% endif %}
            </td>
            <td>
              {% if s %}
              {{ s.score }}/{{ s.total }}
              {% else %}
              <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if s %}
              {{ '%.1f'|format(s.percentage) }}%
              {% else %}
              <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="text-end">
              {% if s %}
              <form class="row g-2 justify-content-end" method="post"
                action="{{ url_for('update_submission', submission_id=s.id) }}">
                <div class="col-auto">
                  <input type="number" class="form-control form-control-sm" name="score" value="{{ s.score }}" min="0"
                    step="1" required>
                </div>
                <div class="col-auto">
                  <input type="number" class="form-control form-control-sm" name="total" value="{{ s.total }}" min="1"
                    step="1" required>
                </div>
                <div class="col-auto">
                  <button type="submit" class="btn btn-sm btn-primary">Save</button>
                </div>
              </form>
              {% else %}
              <span class="text-muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="alert alert-info mb-0">No assignments defined yet.</div>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const labels = JSON.parse('{{ labels|tojson|safe }}');
  const values = JSON.parse('{{ values|tojson|safe }}');
  const ctx = document.getElementById('perfChart').getContext('2d');
  const data = {
    labels,
    datasets: [{
      label: 'Percentage',
      data: values,
      spanGaps: true,
      borderColor: '#5a78f0',
      backgroundColor: 'rgba(90,120,240,0.15)',
      tension: 0.25,
      pointRadius: 4,
      pointBackgroundColor: '#3a55b4'
    }]
  };
  const opt = {
    scales: {
      y: {
        beginAtZero: true,
        max: 100,
        ticks: {
          callback: v => v + '%',
          color: '#ffffff'
        },
        grid: {
          color: '#333333'
        }
      },
      x: {
        ticks: {
          color: '#ffffff'
        },
        grid: {
          color: '#333333'
        }
      }
    },
    plugins: { legend: { display: false } }
  };
  new Chart(ctx, { type: 'line', data, options: opt });
</script>
{% endblock %}