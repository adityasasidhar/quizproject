{% extends "base.html" %}

{% block title %}Exam Selection{% endblock %}

{% block head %}
{{ super() }}
<style>
    body {
        background-color: #f0f4f8;
    }

    .card {
        border: none;
        border-radius: 20px;
        box-shadow: none;
        overflow: hidden;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
    }

    .card-header {
        background-color: transparent;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        padding: 2rem;
        border-radius: 20px 20px 0 0;
    }

    .card-body {
        padding: 2.5rem;
    }

    .form-section {
        background-color: var(--bg-color);
        /* Darker background for section */
        border-radius: 15px;
        padding: 2.5rem;
        margin-bottom: 2.5rem;
        border: 1px solid var(--border-color);
    }

    .form-section h4 {
        margin-bottom: 2rem;
        color: var(--text-primary);
        font-weight: 700;
        border-bottom: 2px solid var(--accent-color);
        padding-bottom: 1rem;
    }

    .selection-box-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }

    .selection-box {
        flex: 1 1 130px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .selection-box:hover {
        transform: translateY(-4px);
        border-color: var(--accent-color);
        color: var(--text-primary);
    }

    .selection-box.selected {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        font-weight: 700;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
    }

    .selection-box input[type="radio"] {
        display: none;
    }

    .btn-primary {
        background-color: var(--accent-color);
        border: none;
        border-radius: 50px;
        padding: 0.85rem 2rem;
        font-weight: 700;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-3px);
        background-color: var(--accent-hover);
    }

    .btn-secondary {
        border-radius: 50px;
        padding: 0.85rem 2rem;
        font-weight: 600;
        background-color: #333;
        color: white;
    }

    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: block;
    }

    .form-control {
        border-radius: 12px;
        padding: 0.85rem 1.25rem;
        border: 1px solid var(--border-color);
        background-color: #2d2d2d;
        color: var(--text-primary);
    }

    .form-text {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-9">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-center mb-0">Configure Your {{ exam_type.replace('_', ' ') | title }} Exam</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('generate_exam') }}">
                        <input type="hidden" name="exam_name" value="{{ exam_type }}">

                        {% if exam_type in ['JEE_MAINS', 'JEE_ADVANCED', 'NEET_UG'] %}
                        <div class="form-section">
                            <h4>Exam Details</h4>
                            <div class="mb-4">
                                <label class="form-label">Difficulty Level</label>
                                <div class="selection-box-container" id="difficulty-selection">
                                    <div class="selection-box" data-value="easy">Easy</div>
                                    <div class="selection-box" data-value="medium">Medium</div>
                                    <div class="selection-box" data-value="hard">Hard</div>
                                </div>
                                <input type="hidden" name="difficulty" id="difficulty" required>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Exam Mode</label>
                                <div class="selection-box-container" id="format-selection">
                                    <div class="selection-box selected" data-value="ONLINE">MCQ Based (Online)</div>
                                    <div class="selection-box" data-value="OFFLINE">Image/PDF Based (Upload)</div>
                                </div>
                                <input type="hidden" name="exam_mode_selection" id="exam_mode_selection" value="ONLINE"
                                    required>
                            </div>
                        </div>
                        {% elif exam_type == 'SCHOOL' %}
                        <div class="form-section">
                            <h4>Exam Configuration</h4>

                            <!-- Common Settings -->
                            <div class="mb-4">
                                <label class="form-label fw-bold text-secondary text-uppercase small">Difficulty
                                    Level</label>
                                <div class="row g-3" id="difficulty-container">
                                    <div class="col-md-4">
                                        <div class="selection-box" data-value="EASY">
                                            <i class="fas fa-smile text-success mb-2 fa-2x"></i>
                                            <div>Easy</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="selection-box" data-value="MEDIUM">
                                            <i class="fas fa-meh text-warning mb-2 fa-2x"></i>
                                            <div>Medium</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="selection-box" data-value="HARD">
                                            <i class="fas fa-frown text-danger mb-2 fa-2x"></i>
                                            <div>Hard</div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="difficulty" id="difficulty" required>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-bold text-secondary text-uppercase small">Exam
                                    Format</label>
                                <div class="row g-3" id="format-container">
                                    <div class="col-md-6">
                                        <div class="selection-box" data-value="MCQ">
                                            <i class="fas fa-list-ul text-primary mb-2 fa-2x"></i>
                                            <div>Multiple Choice</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="selection-box" data-value="SUBJECTIVE">
                                            <i class="fas fa-pen-fancy text-primary mb-2 fa-2x"></i>
                                            <div>Subjective</div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="exam_format" id="exam_format" required>
                            </div>

                            <!-- School Specific Settings -->
                            <hr class="my-4">
                            <h5 class="mb-3 text-primary">Curriculum Details</h5>

                            <div class="mb-4">
                                <label class="form-label fw-bold text-secondary text-uppercase small">Assessment
                                    Type</label>
                                <div class="row g-3" id="school-type-container">
                                    <div class="col-md-6">
                                        <div class="selection-box" data-value="SCHOOL_QUIZ">
                                            <i class="fas fa-laptop-code text-primary mb-2 fa-2x"></i>
                                            <div>MCQ Based (Online)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="selection-box" data-value="SCHOOL_TEST">
                                            <i class="fas fa-file-upload text-primary mb-2 fa-2x"></i>
                                            <div>Image/PDF Based (Upload)</div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="school_exam_type" id="school_exam_type" required>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Board</label>
                                    <select class="form-select" name="board" id="boardSelect" required>
                                        <option value="">Select Board</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Grade</label>
                                    <select class="form-select" name="grade" id="gradeSelect" disabled required>
                                        <option value="">Select Grade</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Language</label>
                                    <select class="form-select" name="language" id="languageSelect" disabled required>
                                        <option value="">Select Language</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Subject</label>
                                    <select class="form-select" name="subject" id="subjectSelect" disabled required>
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Chapters (Select multiple)</label>
                                <select class="form-select" name="chapters" id="chapterSelect" multiple disabled
                                    required style="height: 120px;">
                                    <!-- Chapters populated via JS -->
                                </select>
                                <div class="form-text">Hold Ctrl (Windows) or Cmd (Mac) to select multiple chapters.
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2 mt-5">
                            <button type="submit" class="btn btn-primary btn-lg shadow-sm">
                                <i class="fas fa-magic me-2"></i>Generate Exam
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .selection-box {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .selection-box:hover {
        border-color: #dee2e6;
        background-color: #f8f9fa;
    }

    .selection-box.selected {
        border-color: #0d6efd;
        background-color: #e7f1ff;
        color: #0d6efd;
    }
</style>

<script>
    // Selection Box Logic
    function handleSelection(containerId, inputId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        const input = document.getElementById(inputId);
        const boxes = container.querySelectorAll('.selection-box');

        boxes.forEach(box => {
            box.addEventListener('click', function () {
                boxes.forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                input.value = this.dataset.value;
            });
        });
    }

    handleSelection('difficulty-container', 'difficulty');
    handleSelection('difficulty-selection', 'difficulty');
    handleSelection('format-container', 'exam_format');
    handleSelection('format-selection', 'exam_mode_selection');
    handleSelection('school-type-container', 'school_exam_type');

    // Dynamic Book Selection Logic
    {% if exam_type == 'SCHOOL' %}
    const bookStructure = {{ book_structure| tojson | safe }};

    const boardSelect = document.getElementById('boardSelect');
    const gradeSelect = document.getElementById('gradeSelect');
    const languageSelect = document.getElementById('languageSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const chapterSelect = document.getElementById('chapterSelect');

    // Populate Boards
    for (const board in bookStructure) {
        boardSelect.add(new Option(board, board));
    }

    boardSelect.addEventListener('change', function () {
        gradeSelect.innerHTML = '<option value="">Select Grade</option>';
        languageSelect.innerHTML = '<option value="">Select Language</option>';
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        chapterSelect.innerHTML = '';

        gradeSelect.disabled = true;
        languageSelect.disabled = true;
        subjectSelect.disabled = true;
        chapterSelect.disabled = true;

        if (this.value) {
            const grades = bookStructure[this.value];
            for (const grade in grades) {
                gradeSelect.add(new Option(grade, grade));
            }
            gradeSelect.disabled = false;
        }
    });

    gradeSelect.addEventListener('change', function () {
        languageSelect.innerHTML = '<option value="">Select Language</option>';
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        chapterSelect.innerHTML = '';

        languageSelect.disabled = true;
        subjectSelect.disabled = true;
        chapterSelect.disabled = true;

        if (this.value) {
            const languages = bookStructure[boardSelect.value][this.value];
            for (const lang in languages) {
                languageSelect.add(new Option(lang, lang));
            }
            languageSelect.disabled = false;
        }
    });

    languageSelect.addEventListener('change', function () {
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        chapterSelect.innerHTML = '';

        subjectSelect.disabled = true;
        chapterSelect.disabled = true;

        if (this.value) {
            const subjects = bookStructure[boardSelect.value][gradeSelect.value][this.value];
            for (const subj in subjects) {
                subjectSelect.add(new Option(subj, subj));
            }
            subjectSelect.disabled = false;
        }
    });

    subjectSelect.addEventListener('change', function () {
        chapterSelect.innerHTML = '';
        chapterSelect.disabled = true;

        if (this.value) {
            const chapters = bookStructure[boardSelect.value][gradeSelect.value][languageSelect.value][this.value];
            chapters.forEach(chap => {
                chapterSelect.add(new Option(chap, chap));
            });
            chapterSelect.disabled = false;
        }
    });
    {% endif %}
</script>
{% endblock %}